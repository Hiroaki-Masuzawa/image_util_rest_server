FROM nvidia/cuda:11.8.0-cudnn8-devel-ubuntu20.04
RUN apt update && apt install -y python3 python3-distutils curl git python-is-python3 python3-dev && \
    apt clean && \
    rm -rf /var/lib/apt/lists/*
RUN curl https://bootstrap.pypa.io/get-pip.py | python3
RUN pip3 install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu118 && \
    pip cache purge
# torch-2.2.2+cu118 torchaudio-2.2.2+cu118 torchvision-0.17.2+cu118

# install detectron
RUN pip3 install shapely 
RUN cd / && git clone https://github.com/facebookresearch/detectron2 detectron2_repo
ENV FORCE_CUDA="1"
ENV TORCH_CUDA_ARCH_LIST="6.1;7.5;8.6;8.9"
RUN cd / && pip3 install -e detectron2_repo

RUN pip install fastapi uvicorn opencv-python pillow
RUN apt update && DEBIAN_FRONTEND=noninteractive apt install -y libopencv*
RUN pip install python-multipart
ENV PYTHONPATH=/detectron2_repo